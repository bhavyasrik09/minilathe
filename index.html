<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AR Mini Lathe Digital Twin</title>

<!-- AFRAME + AR -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGW9FxKJ5sUhXw_lW4p2ncZw2qUhI5NvA",
  authDomain: "motor-digital-twin.firebaseapp.com",
  databaseURL: "https://motor-digital-twin-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "motor-digital-twin",
  storageBucket: "motor-digital-twin.firebasestorage.app",
  messagingSenderId: "100929182719",
  appId: "1:100929182719:web:b7aeb33742e4d169f0a5ca"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const liveRef = ref(database, "raw/live");

let temperature = 0;
let vibration = 0;
let runtime = 0;

onValue(liveRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    temperature = parseFloat(data.temperature ?? 0);
    vibration = parseFloat(data.vibration ?? 0);
    runtime = parseFloat(data.runtime_seconds ?? 0);

    document.getElementById("temp").innerText = temperature.toFixed(1);
    document.getElementById("vib").innerText = vibration.toFixed(2);
    document.getElementById("runtime").innerText = runtime;

    updateStatus();
});

function updateStatus() {
    const status = document.getElementById("status");

    if (temperature > 85 || vibration > 1.8 || runtime > 5000) {
        status.innerText = "CRITICAL";
        status.style.background = "#ef4444";
    }
    else if (temperature > 65 || vibration > 1.0 || runtime > 3000) {
        status.innerText = "WARNING";
        status.style.background = "#eab308";
    }
    else {
        status.innerText = "NORMAL";
        status.style.background = "#22c55e";
    }
}
</script>

<!-- ================= MOBILE UI STYLE ================= -->
<style>
body { margin:0; overflow:hidden; font-family:Arial; }

/* Dashboard */
#dashboard {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:320px;
  background:rgba(0,0,0,0.85);
  padding:10px;
  border-radius:12px;
  color:white;
  z-index:10;
  font-size:13px;
  box-shadow:0 4px 10px rgba(0,0,0,0.4);
}

#dashboard h3 {
  margin:0 0 6px 0;
  text-align:center;
}

.data-row {
  display:flex;
  justify-content:space-between;
  margin:4px 0;
}

.status {
  padding:6px;
  margin-top:8px;
  text-align:center;
  font-weight:bold;
  border-radius:6px;
}

/* Loader */
#loader {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:black;
  color:white;
  padding:10px 20px;
  border-radius:8px;
  z-index:20;
}
</style>

<!-- ================= AFRAME COMPONENTS ================= -->
<script>
// Play all animations
AFRAME.registerComponent('play-all-animations', {
  init: function () {
    this.el.addEventListener('model-loaded', () => {
      document.getElementById("loader").style.display = "none";

      const mesh = this.el.getObject3D('mesh');
      if (!mesh.animations || mesh.animations.length === 0) return;

      const mixer = new THREE.AnimationMixer(mesh);
      mesh.animations.forEach(clip => mixer.clipAction(clip).play());
      this.mixer = mixer;
    });
  },
  tick: function (t, dt) {
    if (this.mixer) this.mixer.update(dt / 1000);
  }
});

// Touch rotate
AFRAME.registerComponent('drag-rotate', {
  init: function () {
    this.isDragging = false;
    this.lastX = 0;
    const scene = this.el.sceneEl;

    scene.addEventListener('touchstart', e => {
      this.isDragging = true;
      this.lastX = e.touches[0].clientX;
    });

    scene.addEventListener('touchend', () => {
      this.isDragging = false;
    });

    scene.addEventListener('touchmove', e => {
      if (!this.isDragging) return;
      const dx = (e.touches[0].clientX - this.lastX) * 0.01;
      this.el.object3D.rotation.y += dx;
      this.lastX = e.touches[0].clientX;
    });
  }
});

// Pinch zoom
AFRAME.registerComponent('model-zoom', {
  init: function () {
    this.scale = 0.8;
    this.initialDistance = null;
    const scene = this.el.sceneEl;

    scene.addEventListener('touchmove', e => {
      if (e.touches.length !== 2) return;

      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const distance = Math.sqrt(dx*dx + dy*dy);

      if (!this.initialDistance) {
        this.initialDistance = distance;
      } else {
        const diff = distance - this.initialDistance;
        this.scale += diff * 0.0005;
        this.scale = Math.max(0.3, Math.min(2.5, this.scale));
        this.el.setAttribute('scale', `${this.scale} ${this.scale} ${this.scale}`);
        this.initialDistance = distance;
      }
    });

    scene.addEventListener('touchend', () => {
      this.initialDistance = null;
    });
  }
});
</script>
</head>

<body>

<!-- Loader -->
<div id="loader">Loading Model...</div>

<!-- Dashboard -->
<div id="dashboard">
  <h3>Mini Lathe - Live</h3>

  <div class="data-row">
    <span>Temp:</span>
    <b><span id="temp">--</span> Â°C</b>
  </div>

  <div class="data-row">
    <span>Vibration:</span>
    <b><span id="vib">--</span> g</b>
  </div>

  <div class="data-row">
    <span>Runtime:</span>
    <b><span id="runtime">--</span> sec</b>
  </div>

  <div id="status" class="status">NORMAL</div>
</div>

<!-- AR Scene -->
<a-scene
  embedded
  vr-mode-ui="enabled:false"
  renderer="antialias:false; alpha:true; precision:mediump"
  arjs="sourceType:webcam; debugUIEnabled:false;">

  <a-entity
    id="latheModel"
    gltf-model="desk_lathe_animated.glb"
    play-all-animations
    position="0 0 -4"
    scale="0.8 0.8 0.8"
    drag-rotate
    model-zoom>
  </a-entity>

  <a-entity camera></a-entity>

</a-scene>

</body>
</html>
